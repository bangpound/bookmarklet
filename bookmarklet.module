<?php
// $Id$
/**
 * @file bookmarklet.module
 * TODO: Enter file description here.
 */

/**
 * Implementation of hook_init().
 */
function bookmarklet_init() {
  if (isset($_REQUEST['bookmarklet'])) {
    $GLOBALS['modalframe_page_template'] = TRUE;
    $module_path = drupal_get_path('module', 'modalframe');
    drupal_add_css($module_path .'/css/modalframe.child.css');
  }
}

/**
 * Implementation of hook_menu().
 */
function bookmarklet_menu() {
  $items['bookmarklet/js'] = array(
    'title' => 'Bookmarklet',
    'page callback' => 'bookmarklet_js',
    'access callback' => TRUE,
  );
  $items['node/%node/bookmarklet'] = array(
    'title callback' => 'node_page_title',
    'title arguments' => array(1),
    'page callback' => 'bookmarklet_node_save_confirm',
    'page arguments' => array(1),
    'access callback' => 'node_access',
    'access arguments' => array('view', 1),
    'type' => MENU_CALLBACK
  );
  return $items;
}

/**
 * Implementation of hook_block().
 */
function bookmarklet_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {

    case 'list':
      $blocks[0]['info'] = t('Bookmarklet');
      return $blocks;

    case 'configure':
      if ($delta == 0) {
        $form['node_types'] = array(
          '#type' => 'checkboxes',
          '#title' => t('Node types'),
          '#default_value' => variable_get('bookmarklet_node_types', array('story' => 'story')),
          '#options' => node_get_types('names'),
        );
        return $form;
      }
      break;

    case 'save':
      if ($delta == 0) {
        variable_set('bookmarklet_node_types', $edit['node_types']);
      }
      break;

    case 'view':
      if ($delta == 0) {
        $block['subject'] = t('Bookmarklet');
        $block['content'] = theme('bookmarklet', 'Post on '. variable_get('site_name', 'Drupal'), bookmarklet_script());
      }

      return $block;
  }
}

/**
 * Implementation of hook_form_alter().
 */
function bookmarklet_form_alter(&$form, $form_state, $form_id) {
  if (isset($_REQUEST['bookmarklet']) && isset($form['type']) && isset($form['#node']) && ($form_id == $form['type']['#value'] .'_node_form')) {
    if (!$form_state['submitted']) {
      _bookmarklet_message(array('method' => 'moveToTop'), $_SERVER['HTTP_REFERER']);
    }

    if (module_exists('vertical_tabs')) {
      vertical_tabs_remove_vertical_tabs($form);
    }

    // Recurse through all children.
    _bookmarklet_form_alter($form, $form_state, $form_id);

    // Definitely shrink the body field.
    if (!empty($form['body_field'])) {
      $form['body_field']['body']['#rows'] = 5;

      // Drupal resizable behavior fake-out. It's not helpful in a small frame.
      $form['body_field']['body']['#attributes'] = array(
        'class' => 'textarea-processed',
      );
    }

    // Add submit handler.
    $form['buttons']['submit']['#submit'][] = 'bookmarklet_form_submit';

    // Store the referrer which will be used in the submit handler to direct
    // the child JS to tell the parent document close the iframe.
    // TODO: Workaround for missing referrers.
    $form['bookmarklet_referrer'] = array(
      '#type' => 'hidden',
      '#default_value' => $_SERVER['HTTP_REFERER'],
    );
  }
}

/**
 * Generic form submit handler.
 *
 * @see modalframe_form_submit().
 * @ingroup forms
 */
function bookmarklet_form_submit($form, &$form_state) {
  $query = array(
    'bookmarklet' => TRUE,
    'origin' => $form_state['values']['bookmarklet_referrer'],
  );
  $form_state['redirect'] = array('node/'. $form_state['nid'] .'/bookmarklet', $query);
}

function _bookmarklet_form_alter(&$elements, $form_state, $form_id) {
  foreach (element_children($elements) as $key) {
    if (isset($elements[$key]) && $elements[$key]) {
      if (in_array($key, array('body_field', 'field_link', 'buttons'))) {
        continue;
      }

      // Only worry about form elements that have UI.
      if (isset($elements[$key]['#type']) && in_array($elements[$key]['#type'], array('value', 'hidden'))) {
        continue;
      }

      // Recurse through all children.
      _bookmarklet_form_alter($elements[$key], $form_state, $form_id);

      // Only worry about form elements the user can access.
      if (!isset($elements[$key]['#access']) || $elements[$key]['#access']) {
        if (!isset($elements[$key]['#required']) || !$elements[$key]['#required']) {
          $elements[$key]['#access'] = FALSE;
        }
      }
    }
  }
}

/**
 * Set up a message to pass from the iframe to the parent document.
 */
function _bookmarklet_message($event = NULL, $target_url = NULL) {
  static $stored_message = array();

  if (!is_null($event) && !is_null($target_url)) {
    $stored_message = array(
      'event' => $event,
      'target_url' => $target_url
    );
  }
  return $stored_message;
}

function bookmarklet_footer($main = 0) {
  if ($message = _bookmarklet_message()) {
    $path = drupal_get_path('module', 'bookmarklet');
    drupal_add_js($path .'/jquery-postmessage/jquery.ba-postmessage.js', 'module', 'footer');
    drupal_add_js($path .'/bookmarklet.child.js', 'module', 'footer');
    drupal_add_js(array('bookmarklet' => $message), 'setting', 'footer');
  }
}

/**
 * Implementation of hook_theme().
 */
function bookmarklet_theme($existing, $type, $theme, $path) {
  return array(
    'bookmarklet' => array(
      'arguments' => array(
        'text' => '',
        'script' => '',
        'options' => array(),
      ),
    ),
  );
}

/**
 * Theme the bookmarklet link.
 *
 * Takes the same arguments as l() but deliberately side steps the XSS security
 * filter because our goal is XSS.
 */
function theme_bookmarklet($text = '', $script = '', $options = array()) {
  $options['absolute'] = TRUE;
  $decoy = 'http://BOOKMARKLET';
  $link = l($text, $decoy, $options);
  $script = 'javascript:'. trim($script);
  return str_replace($decoy, $script, $link);
}

function bookmarklet_script() {
  global $base_url;
  $path = drupal_get_path('module', 'bookmarklet');
  $instance_name = md5($base_url);

  $script = <<<EOT
// TODO load bookmarklet script once even if clicked multiple times.
/* global $,drupalBookmarklet */
(function () {
  var host,path,b;
  host = '$base_url';
  path = '$path';
  b = document.createElement('SCRIPT');
  b.type = 'text/javascript';
  b.src = host + '/' + path + '/bookmarklet.js?' + (Math.random());
  b.onload = function () { var __drupalBookmarklet$instance_name = new drupalBookmarklet(host, path); };
  document.getElementsByTagName('head')[0].appendChild(b);
}());
EOT;
  module_load_include('php', 'bookmarklet', 'jsmin-php/jsmin');

  return JSMin::minify($script);
}

function bookmarklet_js() {
  $node_types = array_filter(variable_get('bookmarklet_node_types', array('story' => 'story')));
  // We are returning JavaScript, so tell the browser.
  drupal_set_header('Content-Type: text/javascript; charset=utf-8');

  $settings = array(
    'types' => array(),
  );
  foreach (node_get_types('types') as $type) {
    if (in_array($type->type, $node_types) && node_access('create', $type->type)) {
      $settings['types'][str_replace('_', '-', $type->type)] = drupal_ucfirst($type->name);
    }
  }

  if (!empty($_GET['callback'])) {
    echo $_GET['callback'] .'('. drupal_to_js($settings) .');';
  }
  else {
    echo drupal_to_js($settings);
  }
}

/**
 * Node save confirmation page.
 */
function bookmarklet_node_save_confirm($node) {
  if (!empty($_GET['origin'])) {
    _bookmarklet_message(array('method' => 'close'), $_GET['origin']);
  }
  $links = array();
  $options = array(
    'attributes' => array(
      'target' => '_blank',
    ),
  );
  $links[] = l('View', 'node/'. $node->nid, $options);
  $links[] = l('Edit', 'node/'. $node->nid .'/edit', $options);
  return theme('item_list', $links);
}
